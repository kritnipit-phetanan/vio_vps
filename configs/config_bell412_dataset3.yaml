# ============================================================================
# VIO Configuration: Bell 412 - Dataset 3 (Forward Motion)
# ============================================================================
# Camera: Fisheye (Kannala-Brandt model) - NEEDS CALIBRATION
# IMU: Onboard IMU @ 400 Hz - NEEDS CALIBRATION
# Dataset: bell412_dataset3 - forward motion without heavy rotation
# ============================================================================

# Camera Intrinsics (Kannala-Brandt Fisheye Model)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
# Calibrated using VINS-Fusion camera calibration tool
camera:
  model: "kannala_brandt"
  image_width: 1440
  image_height: 1080
  
  # Kannala-Brandt distortion parameters (CALIBRATED)
  k2: -0.0764245
  k3:  0.0322856
  k4: -0.0445168
  k5:  0.0163317
  
  # Principal point and focal length (CALIBRATED)
  mu:  829.224
  mv:  829.454
  u0:  833.937
  v0:  562.509

# Camera-IMU Extrinsics (Body frame to Camera frame)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
# Calibrated using Kalibr package
extrinsics:
  # Nadir camera (downward-facing) - CALIBRATED
  nadir:
    name: "BODY_T_CAMDOWN"
    transform:
      - [-0.01039363,  0.99994595,  0.00027614, -0.27939175]
      - [-0.99982944, -0.01038820, -0.01527021,  0.00394073]
      - [-0.01526652, -0.00043481,  0.99988337, -0.00039529]
      - [ 0.0,         0.0,         0.0,         1.0        ]
  
  # Front camera (forward-facing) - CALIBRATED
  front:
    name: "BODY_T_CAMFRONT"
    transform:
      - [-0.04200713, -0.01166497,  0.99904921,  0.17666233]
      - [ 0.99899047,  0.01544242,  0.04218496, -0.05171531]
      - [-0.01591983,  0.99981271,  0.01100451, -0.04656282]
      - [ 0.0,         0.0,         0.0,         1.0        ]
  
  # Side camera (not available in Bell 412 dataset, using placeholder)
  side:
    name: "BODY_T_CAMSIDE"
    transform:
      - [ 1.0,  0.0,  0.0,  0.0]
      - [ 0.0,  0.0,  1.0,  0.2]
      - [ 0.0,  1.0,  0.0, -0.05]
      - [ 0.0,  0.0,  0.0,  1.0]

# IMU Parameters (Noise characteristics)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
imu:
  # Standard noise parameters (CALIBRATED)
  acc_n: 0.08      # Accelerometer noise density [m/s²/√Hz]
  gyr_n: 0.004     # Gyroscope noise density [rad/s/√Hz]
  acc_w: 0.00004   # Accelerometer random walk [m/s³/√Hz]
  gyr_w: 0.0001    # Gyroscope random walk [rad/s²/√Hz]
  g_norm: 9.803    # Gravity magnitude [m/s²]
  
  # Initial gyro bias (estimated from static period at start)
  # CRITICAL: Raw data shows gyro mean = -2.58°/s which causes yaw drift!
  # Initial static samples show: [-0.0023, -0.0038, -0.0077] rad/s
  initial_gyro_bias: [-0.0023, -0.0038, -0.0077]
  
  # Enable bias estimation from initial static samples
  estimate_bias: true
  
  # Preintegration-specific (RELAXED: allow filter to accept VIO/VPS/DEM corrections)
  # Higher noise = more uncertainty in IMU = filter trusts VIO/VPS/DEM more
  # Analysis: IMU drift caused 60 m/s velocity error - need faster bias adaptation
  preintegration:
    acc_n: 0.20        # HIGHER than standard (allow VIO corrections)
    gyr_n: 0.010       # HIGHER than standard (allow orientation corrections)  
    acc_w: 0.0005      # 5× HIGHER (MUCH faster accel bias adaptation for altitude)
    gyr_w: 0.0005      # 5× HIGHER (faster gyro bias adaptation)

# IMU-GNSS Lever Arm (Body frame to GNSS antenna)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html#imu-gnss-extrinsic-calibration
# This is T_BG (Body to GNSS) - the translation from IMU to GNSS antenna
# In FRD body frame: X=Forward, Y=Right, Z=Down
imu_gnss_extrinsics:
  # Lever arm in body frame [meters]
  # X = -0.1444 → GNSS antenna is 14.4 cm BEHIND IMU
  # Y =  0.0553 → GNSS antenna is 5.5 cm to the RIGHT of IMU  
  # Z = -0.5347 → GNSS antenna is 53.5 cm ABOVE IMU (negative Z in FRD = up)
  lever_arm: [-0.14440, 0.05530, -0.53470]
  
  # Full 4x4 transformation matrix (rotation is identity for Bell 412)
  transform:
    - [1.0, 0.0, 0.0, -0.14440]
    - [0.0, 1.0, 0.0,  0.05530]
    - [0.0, 0.0, 1.0, -0.53470]
    - [0.0, 0.0, 0.0,  1.0]

# Plane-Aided MSCKF Configuration
# Detects planar surfaces to constrain triangulation depth
# Helps reduce fail_depth_sign failures (43.2% in baseline)
plane:
  enabled: true  # ENABLED for Phase 3 testing
  min_points_per_plane: 10  # Minimum 3D points needed to fit a plane
  angle_threshold_deg: 15.0  # Max angle difference (°) for normal clustering
  distance_threshold_m: 0.15  # Max point-to-plane distance (m) for inliers
  min_area_m2: 0.5  # Minimum plane area (m²) to be considered valid
  measurement_noise_m: 0.05  # Plane constraint measurement noise (m)
  use_aided_triangulation: true  # Project triangulated points onto detected planes
  use_constraints: true  # Apply plane constraints as EKF updates
  max_planes: 10  # Maximum number of planes to track simultaneously

# Magnetometer Calibration
# Data is pre-normalized (unit vectors), not in standard µT
# Calibration recomputed using PPK GPS ground truth heading
# Date: 2025-02-07
magnetometer:
  # Hard-iron offset (CALIBRATED - normalized units)
  hard_iron_offset: [0.243467, -0.194837, 0.341668]
  
  # Soft-iron matrix (CALIBRATED - ellipsoid correction)
  soft_iron_matrix:
    - [0.702036, 0.0, 0.0]
    - [0.0, 0.715855, 0.0]
    - [0.0, 0.0, 5.597808]
  
  # Heading formula: atan2(-mag_y, mag_x) - Y-axis flipped for correct NED alignment
  # IMPORTANT: Must flip Y-axis sign when computing heading from calibrated mag
  heading_formula: "atan2(-mag_y, mag_x)"
  
  # Magnetic declination [radians]
  # RECALIBRATED 2025-12-01 from PPK ground truth:
  #   - PPK yaw (ENU) = 131.55°
  #   - First attempt with -1.05° gave yaw_mag = 121°
  #   - Offset needed: 131.55 - 121 = 10.55°
  #   - New declination = -1.05 - 10.55 = -11.60°
  declination: -0.2025  # -11.60° to produce yaw=131.6° matching GT
  
  # Field strength bounds (normalized units, not µT)
  expected_field_strength: 0.63  # Mean normalized field
  min_field_strength: 0.10       # REDUCED: allow weaker field readings
  max_field_strength: 0.95       # RELAXED for noisy environment
  
  # Update rate limiting
  update_rate_limit: 1   # REDUCED: Process every sample for faster convergence
  
  # Convergence window (seconds) - skip mag during initial settling
  # FIX 2025-12-01b: Reduced from 5s to 0s - START IMMEDIATELY!
  # Problem: Even 5s delay causes 19.8° initial yaw error (gyro bias ~4°/s)
  # Solution: Start mag updates immediately to prevent any gyro-only drift
  # Note: PPK initial yaw is accurate, but VIO gyro integration drifts fast
  convergence_window: 0.0  # 0s = start mag updates immediately
  
  # Use raw body-frame heading (GPS-calibrated)
  # This bypasses IMU tilt compensation which has frame alignment issues
  use_raw_heading: true
  
  # Apply initial yaw correction from magnetometer at startup
  # DISABLED: Initial mag correction caused 173° yaw change which broke DEM fusion
  # The IMU initial orientation is more reliable for this dataset
  apply_initial_correction: false
  
  # ===== NEW: Enhanced Magnetometer Filtering (v2.9.1) =====
  # EMA (Exponential Moving Average) smoothing and gyro consistency check
  # TUNED 2025-12-11: Relaxed parameters for helicopter dynamics
  ema_alpha: 0.3                # Smoothing factor: 0.3 = 30% new, 70% old
  max_yaw_rate_deg: 150.0       # Maximum expected yaw rate [deg/s] (was 30.0, too low for helicopter)
  gyro_consistency_threshold_deg: 30.0  # Max deviation from gyro integration [deg] (was 10.0)
  r_inflate: 2.0                # R inflation factor for inconsistent measurements (was 5.0)

# EKF Process Noise
# RECALIBRATED 2025-02-07: Magnetometer now GPS-calibrated with std~16°
# Re-enabled magnetometer updates with appropriate uncertainty
process_noise:
  sigma_accel: 0.5           # Process accel noise
  # NOTE: sigma_vo removed - use vio.sigma_vo instead (line 211)
  sigma_vps_xy: 0.8          # VPS position measurement [m]
  sigma_agl_z: 1.0           # Height/DEM constraint
  sigma_mag_yaw: 0.15        # RE-ENABLED: ~17° (std from GPS calibration = 16°, add margin)

# VIO/VO Parameters
# TUNED FOR SLOW MOTION / HOVERING (Bell 412 dataset characteristics)
# Key fix: min_msckf_baseline reduced from 0.03 → 0.01 to allow more triangulation
# (observed baseline ~0.026m was failing the 0.03m threshold)
vio:
  # Enable optical flow velocity updates (v2.9.8.2: gyro-compensated)
  # Helps reduce XY drift in outdoor long-range flights without VPS
  use_vio_velocity: true     # Enable optical flow → velocity → EKF updates
  
  # Parallax thresholds
  # CRITICAL FIX: was 1.0px but actual parallax ~0.3-0.9px during hover/slow motion
  # VIO velocity was ALWAYS SKIPPED because parallax < threshold
  min_parallax_px: 0.3       # Minimum optical flow [pixels] - REDUCED for slow Bell 412 flight
  min_msckf_baseline: 0.01   # CRITICAL FIX: was 0.03 (baseline ~0.026m was failing) → now 0.01
  
  # MSCKF parameters (PERMISSIVE for noisy/slow motion)
  msckf_chi2_multiplier: 15.0        # Chi-square threshold multiplier
  msckf_max_reprojection_error: 8.0  # Max reprojection error [pixels]
  
  # Feature tracking
  min_inliers: 6             # Minimum RANSAC inliers
  ratio_test: 0.80           # Lowe's ratio test threshold (more permissive)
  
  # Optical flow velocity parameters (v2.9.8.2)
  sigma_vo: 0.5              # Velocity measurement uncertainty [m/s]
  min_tracked_features: 50   # Minimum features for velocity update
  fast_rotation_threshold: 0.5236  # Skip if rotation > 30°/s (rad/s)
  
  # Camera view configurations
  # CRITICAL FIX: use_vz_only=true for nadir camera
  # Reason: Nadir camera has translation direction ambiguity - we don't know
  # horizontal velocity DIRECTION without absolute heading reference (MSCKF or VPS)
  # When MSCKF fails (100%), using horizontal velocity causes massive drift (5km in 5min)
  views:
    nadir:
      nadir_threshold_deg: 30.0
      sigma_scale_xy: 3.0          # INCREASED: high uncertainty for XY from nadir flow
      sigma_scale_z: 2.0           # Nadir camera has GOOD Z observability actually
      use_vz_only: false           # CRITICAL FIX v2.9.8.4: Enable XY velocity (was true)
      min_parallax: 0.3            # LOWERED: accept slow motion flow (was 0.5)
      max_corners: 2500            # More features for stability
    
    front:
      nadir_threshold_deg: 60.0
      sigma_scale_xy: 0.8          # Slightly increased from 0.6
      sigma_scale_z: 1.5           # Slightly increased from 1.2
      use_vz_only: false
      min_parallax: 1.0            # VERY LOW for slow forward motion
      max_corners: 2500
    
    side:
      nadir_threshold_deg: 60.0
      sigma_scale_xy: 1.0
      sigma_scale_z: 1.2
      use_vz_only: false
      min_parallax: 8
      max_corners: 2000

# Default camera view (nadir/front/side)
default_camera_view: "nadir"

# Use fisheye undistortion backend
use_fisheye: true

# ============================================================================
# ZUPT (Zero Velocity Update) Configuration (v2.9.8)
# ============================================================================
# Detects stationary periods to apply zero-velocity constraints.
# DISABLED for helicopters: continuous vibration prevents true zero-velocity state.
# Use vibration detection instead for adaptive measurement uncertainty.
zupt:
  enabled: false                  # DISABLED: Helicopters never truly stationary (rotor vibration)
  accel_threshold: 0.5            # Acceleration threshold [m/s²] (reduced for helicopter vibration)
  gyro_threshold: 0.05            # Gyroscope threshold [rad/s] (~3°/s)
  min_duration: 2.0               # Minimum stationary duration [seconds]
  velocity_threshold: 0.2         # Velocity magnitude threshold [m/s]
  consecutive_required: 5         # Consecutive stationary samples required

# ============================================================================
# NEW: Fisheye Rectification (v2.8.0)
# ============================================================================
# Converts fisheye images to pinhole for better feature tracking.
# DISABLED: Bell412 dataset already uses calibrated Kannala-Brandt model.
# Enabling causes parallax scale errors due to rectification.
# Only enable for uncalibrated or severely distorted fisheye cameras.
rectification:
  use_rectifier: false       # DISABLED: VIO already handles fisheye correctly
  rectify_fov_deg: 90.0      # Output field of view for virtual pinhole camera

# ============================================================================
# NEW: Loop Closure Detection (v2.8.0)
# ============================================================================
# Detects when vehicle returns to previously visited location.
# Corrects accumulated yaw drift using visual feature matching.
# DISABLED for long-range outdoor flights without loops (CPU-intensive, low benefit)
loop_closure:
  use_loop_closure: false     # DISABLED: No loops in long-range flight, saves 0.3-0.5s/keyframe
  position_threshold: 30.0    # Distance threshold to consider loop candidate [m]
  min_keyframe_dist: 15.0     # Minimum distance between keyframes [m]
  min_keyframe_yaw: 20.0      # Minimum yaw change between keyframes [deg]
  min_frame_gap: 50           # Minimum frame gap for loop detection
  min_inliers: 15             # Minimum feature match inliers

# ============================================================================
# NEW: Vibration Detection (v2.8.0)
# ============================================================================
# Detects high vibration periods (helicopter rotor effects).
# Can be used to adjust measurement uncertainties.
vibration:
  use_vibration_detector: true
  window_size: 50             # Number of samples for vibration detection
  threshold_multiplier: 5.0   # Multiplier of acc_n for vibration threshold
