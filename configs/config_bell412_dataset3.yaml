# ============================================================================
# VIO Configuration: Bell 412 - Dataset 3 (Forward Motion)
# ============================================================================
# Camera: Fisheye (Kannala-Brandt model) - NEEDS CALIBRATION
# IMU: Onboard IMU @ 400 Hz - NEEDS CALIBRATION
# Dataset: bell412_dataset3 - forward motion without heavy rotation
# ============================================================================

# Camera Intrinsics (Kannala-Brandt Fisheye Model)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
# Calibrated using VINS-Fusion camera calibration tool
camera:
  model: "kannala_brandt"
  image_width: 1440
  image_height: 1080
  
  # Kannala-Brandt distortion parameters (CALIBRATED)
  k2: -0.0764245
  k3:  0.0322856
  k4: -0.0445168
  k5:  0.0163317
  
  # Principal point and focal length (CALIBRATED)
  mu:  829.224
  mv:  829.454
  u0:  833.937
  v0:  562.509

# Camera-IMU Extrinsics (Body frame to Camera frame)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
# Calibrated using Kalibr package
extrinsics:
  # Nadir camera (downward-facing) - CALIBRATED
  nadir:
    name: "BODY_T_CAMDOWN"
    transform:
      - [-0.01039363,  0.99994595,  0.00027614, -0.27939175]
      - [-0.99982944, -0.01038820, -0.01527021,  0.00394073]
      - [-0.01526652, -0.00043481,  0.99988337, -0.00039529]
      - [ 0.0,         0.0,         0.0,         1.0        ]
  
  # Front camera (forward-facing) - CALIBRATED
  front:
    name: "BODY_T_CAMFRONT"
    transform:
      - [-0.04200713, -0.01166497,  0.99904921,  0.17666233]
      - [ 0.99899047,  0.01544242,  0.04218496, -0.05171531]
      - [-0.01591983,  0.99981271,  0.01100451, -0.04656282]
      - [ 0.0,         0.0,         0.0,         1.0        ]
  
  # Side camera (not available in Bell 412 dataset, using placeholder)
  side:
    name: "BODY_T_CAMSIDE"
    transform:
      - [ 1.0,  0.0,  0.0,  0.0]
      - [ 0.0,  0.0,  1.0,  0.2]
      - [ 0.0,  1.0,  0.0, -0.05]
      - [ 0.0,  0.0,  0.0,  1.0]

# IMU Parameters (Noise characteristics)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html
imu:
  # Standard noise parameters (CALIBRATED)
  acc_n: 0.08      # Accelerometer noise density [m/s²/√Hz]
  gyr_n: 0.004     # Gyroscope noise density [rad/s/√Hz]
  acc_w: 0.00004   # Accelerometer random walk [m/s³/√Hz]
  gyr_w: 0.0001    # Gyroscope random walk [rad/s²/√Hz]
  g_norm: 9.803    # Gravity magnitude [m/s²]
  accel_includes_gravity: true  # IMU linear acceleration includes gravity component
  
  # Initial gyro bias (estimated from static period at start)
  # CRITICAL: Raw data shows gyro mean = -2.58°/s which causes yaw drift!
  # Initial static samples show: [-0.0023, -0.0038, -0.0077] rad/s
  initial_gyro_bias: [-0.0023, -0.0038, -0.0077]
  
  # Initial accelerometer bias (estimated from first 100 samples)
  # ENU frame: measured [-0.103, 0.392, -9.682], expected [0, 0, -9.803]
  # Bias = measured - expected
  initial_accel_bias: [0.391959, -0.103155, 0.121209]
  
  # Enable bias estimation from initial static samples
  estimate_bias: true
  
  # Estimator Mode (v3.7.0: enum instead of boolean)
  # "imu_step_preint_cache": IMU-driven @ 400Hz with preintegration cache + sub-sample timestamp precision
  # "event_queue_output_predictor": Event-driven with propagate-to-timestamp (TODO: not implemented yet)
  estimator_mode: "imu_step_preint_cache"
  
  # Flight phase detection (v3.4.0: State-based with configurable thresholds)
  # - SPINUP (0): High vibration + low velocity (rotor spinup)
  # - EARLY (1): High velocity uncertainty (filter not converged)
  # - NORMAL (2): Stable flight with converged estimates
  phase_detection:
    spinup_velocity_thresh: 1.0        # m/s - horizontal velocity below this = stationary
    spinup_vibration_thresh: 0.3       # rad/s - gyro std above this = high vibration
    spinup_altitude_change_thresh: 5.0 # m - altitude change below this = still on ground
    early_velocity_sigma_thresh: 3.0   # m/s - velocity uncertainty above this = unconverged
  
  # Preintegration-specific (v3.7.2: REDUCE bias random walk to prevent divergence)
  # Previous v2.9.9.10 with 3× increase caused MASSIVE bias drift:
  #   - Accel bias: 0 → 3483 mg over flight (DIVERGED!)
  #   - Gyro bias: 0 → 204 mrad/s (DIVERGED!)
  #   - Root cause: acc_w/gyr_w too high → bias drifts unconstrained
  # Strategy: Keep acc_n/gyr_n high for velocity uncertainty, but LOCK DOWN bias drift
  preintegration:
    acc_n: 0.60        # Keep 3× (measurement noise for velocity)
    gyr_n: 0.030       # Keep 3× (measurement noise for attitude)
    acc_w: 0.00004     # REDUCED 37× (was 0.0015) - LOCK bias estimates
    gyr_w: 0.0001      # REDUCED 15× (was 0.0015) - LOCK bias estimates

# IMU-GNSS Lever Arm (Body frame to GNSS antenna)
# Source: https://mun-frl-vil-dataset.readthedocs.io/en/latest/Calibration.html#imu-gnss-extrinsic-calibration
# This is T_BG (Body to GNSS) - the translation from IMU to GNSS antenna
# In FRD body frame: X=Forward, Y=Right, Z=Down
imu_gnss_extrinsics:
  # Lever arm in body frame [meters]
  # X = -0.1444 → GNSS antenna is 14.4 cm BEHIND IMU
  # Y =  0.0553 → GNSS antenna is 5.5 cm to the RIGHT of IMU  
  # Z = -0.5347 → GNSS antenna is 53.5 cm ABOVE IMU (negative Z in FRD = up)
  lever_arm: [-0.14440, 0.05530, -0.53470]
  
  # Full 4x4 transformation matrix (rotation is identity for Bell 412)
  transform:
    - [1.0, 0.0, 0.0, -0.14440]
    - [0.0, 1.0, 0.0,  0.05530]
    - [0.0, 0.0, 1.0, -0.53470]
    - [0.0, 0.0, 0.0,  1.0]

# Plane-Aided MSCKF Configuration
# Detects planar surfaces to constrain triangulation depth
# Helps reduce fail_depth_sign failures (43.2% in baseline)
plane:
  enabled: true  # ENABLED for Phase 3 testing
  min_points_per_plane: 10  # Minimum 3D points needed to fit a plane
  angle_threshold_deg: 15.0  # Max angle difference (°) for normal clustering
  distance_threshold_m: 0.15  # Max point-to-plane distance (m) for inliers
  min_area_m2: 0.5  # Minimum plane area (m²) to be considered valid
  measurement_noise_m: 0.05  # Plane constraint measurement noise (m)
  use_aided_triangulation: true  # Project triangulated points onto detected planes
  use_constraints: true  # Apply plane constraints as EKF updates
  max_planes: 10  # Maximum number of planes to track simultaneously

# Magnetometer Calibration
# Data is pre-normalized (unit vectors), not in standard µT
# Calibration recomputed using PPK GPS ground truth heading
# Date: 2025-02-07
# 
# DISABLED v2.9.10.4: MAG calibration shows 36° drift by end of flight
# Analysis: innovation_z grows from -2.5° (early) to +36° (late)
# Root cause: Hard/soft iron calibration doesn't account for helicopter field distortion
# v2.9.10.8: RE-ENABLING magnetometer to fix yaw drift
# Results: v2.9.10.4 (mag off) = 746m, 100°+ yaw drift in first 30s
# v2.9.10.7 (mag off) = 726m, similar yaw drift
# v2.9.10.12: Re-enabling magnetometer to fix yaw drift
# Without magnetometer, yaw drifts 90° in 51 seconds from gyro bias alone
magnetometer:
  enabled: true   # v3.9.6: RE-ENABLED with full recalibration
  
  # Hard-iron offset (v3.9.6: RECALIBRATED from data range center)
  # Old: [0.243467, -0.194837, 0.341668]
  hard_iron_offset: [0.249140, -0.261974, 0.317021]
  
  # Soft-iron matrix (v3.9.6: RECALIBRATED - diagonal scale factors)
  # Old Z-scale was 5.6 (too high), now 3.4 (more reasonable)
  soft_iron_matrix:
    - [0.753133, 0.0, 0.0]
    - [0.0, 0.726562, 0.0]
    - [0.0, 0.0, 3.379869]
  
  # Heading formula: atan2(-mag_y, mag_x) - Y-axis flipped for correct NED alignment
  # IMPORTANT: Must flip Y-axis sign when computing heading from calibrated mag
  heading_formula: "atan2(-mag_y, mag_x)"
  
  # Magnetic declination [radians]
  # v3.9.6: RECALIBRATED - with correct hard/soft iron, declination is now minimal
  # Previously -35.8° was compensating for incorrect soft iron
  declination: 0.0009  # 0.1° (was -35.8° with old calibration)
  
  # Field strength bounds (normalized units, not µT)
  expected_field_strength: 0.63  # Mean normalized field
  min_field_strength: 0.10       # REDUCED: allow weaker field readings
  max_field_strength: 0.95       # RELAXED for noisy environment
  
  # Update rate limiting
  update_rate_limit: 1   # REDUCED: Process every sample for faster convergence
  
  # Convergence window (seconds) - skip mag during initial settling
  # FIX 2025-12-01b: Reduced from 5s to 0s - START IMMEDIATELY!
  # Problem: Even 5s delay causes 19.8° initial yaw error (gyro bias ~4°/s)
  # Solution: Start mag updates immediately to prevent any gyro-only drift
  # Note: PPK initial yaw is accurate, but VIO gyro integration drifts fast
  convergence_window: 0.0  # 0s = start mag updates immediately
  
  # Use raw body-frame heading (GPS-calibrated)
  # This bypasses IMU tilt compensation which has frame alignment issues
  # NOTE: declination=-35.8° was calibrated for this mode
  use_raw_heading: true
  
  # Apply initial yaw correction from magnetometer at startup
  # v2.9.10.12: RE-ENABLED to align initial yaw with mag reference
  # This ensures zero initial innovation and prevents runaway yaw drift
  apply_initial_correction: true
  
  # ===== NEW: Enhanced Magnetometer Filtering (v2.9.1) =====
  # EMA (Exponential Moving Average) smoothing and gyro consistency check
  # TUNED 2025-12-11: Relaxed parameters for helicopter dynamics
  ema_alpha: 0.3                # Smoothing factor: 0.3 = 30% new, 70% old
  max_yaw_rate_deg: 150.0       # Maximum expected yaw rate [deg/s] (was 30.0, too low for helicopter)
  gyro_consistency_threshold_deg: 30.0  # Max deviation from gyro integration [deg] (was 10.0)
  r_inflate: 2.0                # R inflation factor for inconsistent measurements (was 5.0)
  
  # ===== NEW: Online Mag Bias Estimation (v3.9.7) =====
  # Mag bias (hard iron) is now estimated online in EKF state
  sigma_mag_bias_init: 0.01      # Initial uncertainty for mag bias [normalized]
  sigma_mag_bias: 0.0001         # Process noise for mag bias (random walk) [normalized/sqrt(s)]
  use_estimated_bias: true      # Use EKF-estimated bias instead of config hard_iron

# EKF Process Noise
# v2.9.9.10: AGGRESSIVE 3× increase (v2.9.9.9's 2× still showed 13.1σ overconfidence)
# DIAGNOSIS: v2.9.9.9 velocity σ = 0.5 m/s, but actual error = 6.5 m/s
#   → Filter severely overconfident, NEES = 1903 (should be ~3.0)
# SOLUTION: 3× increase to reach target velocity σ of 2-3 m/s
process_noise:
  sigma_accel: 1.5           # INCREASED 3× (was 0.5) - aggressive increase
  # NOTE: sigma_vo removed - use vio.sigma_vo instead (line 211)
  sigma_vps_xy: 0.8          # VPS position measurement [m]
  sigma_agl_z: 1.0           # Height/DEM constraint
  sigma_mag_yaw: 0.10        # ~5.7° (reduced after fixing declination) - tighter MAG correction

# VIO/VO Parameters
# TUNED FOR SLOW MOTION / HOVERING (Bell 412 dataset characteristics)
# Key fix: min_msckf_baseline reduced from 0.03 → 0.01 to allow more triangulation
# (observed baseline ~0.026m was failing the 0.03m threshold)
vio:
  # Enable optical flow velocity updates (v2.9.8.2: gyro-compensated)
  # Helps reduce XY drift in outdoor long-range flights without VPS
  use_vio_velocity: true     # Enable optical flow → velocity → EKF updates
  
  # v2.9.10.5: Fixed AGL for VIO velocity scale (GPS-denied compliant)
  # Problem: DEM elevation (110.5m) vs GPS MSL (116.7m) have ~6m offset
  #          This gives AGL=6.2m but helicopter actually flies at ~100-200m AGL
  #          Wrong AGL → wrong VIO velocity scale (100/6.2 = 16x error!)
  # Solution: Override with reasonable helicopter cruise AGL
  # Analysis: GPS altitude varies 116-232m, so max AGL ~120m, typical ~80m
  # initial_agl_override: 100.0  # DISABLED - v2.9.10.5 showed AGL=100m makes things WORSE
  # v2.9.10.4 with computed AGL=6.2m: 746m error
  # v2.9.10.5 with override AGL=100m: 1495m error (2x worse!)
  # The computed AGL from DEM/GPS MSL difference actually works better for VIO scale
  
  # Parallax thresholds
  # CRITICAL FIX: was 1.0px but actual parallax ~0.3-0.9px during hover/slow motion
  # VIO velocity was ALWAYS SKIPPED because parallax < threshold
  min_parallax_px: 0.3       # Minimum optical flow [pixels] - REDUCED for slow Bell 412 flight
  min_msckf_baseline: 0.01   # CRITICAL FIX: was 0.03 (baseline ~0.026m was failing) → now 0.01
  
  # MSCKF parameters (PERMISSIVE for noisy/slow motion)
  # TUNED v3.9.2: Increased from 8.0→12.0 to reduce fail_reproj_error (was 36.6%)
  msckf_chi2_multiplier: 15.0        # Chi-square threshold multiplier
  msckf_max_reprojection_error: 12.0  # Max reprojection error [pixels] (increased from 8.0)
  
  # Feature tracking
  min_inliers: 6             # Minimum RANSAC inliers
  ratio_test: 0.80           # Lowe's ratio test threshold (more permissive)
  
  # Optical flow velocity parameters (v2.9.9.10: Increased measurement noise)
  # v2.9.9.9 innovation mean = 6.57 m/s → need larger R to match reality
  sigma_vo: 1.5              # INCREASED 3× (was 0.5) - realistic measurement uncertainty
  min_tracked_features: 50   # Minimum features for velocity update
  fast_rotation_threshold: 0.5236  # Skip if rotation > 30°/s (rad/s)
  
  # MSCKF sliding window configuration (v3.9.1)
  # Controls camera clone management and feature track lifetime
  msckf:
    max_clone_size: 11       # Maximum camera poses in sliding window (11 is OpenVINS default)
    min_track_length: 4      # Minimum observations for MSCKF triangulation
  
  # Camera view configurations
  # CRITICAL FIX: use_vz_only=true for nadir camera
  # Reason: Nadir camera has translation direction ambiguity - we don't know
  # horizontal velocity DIRECTION without absolute heading reference (MSCKF or VPS)
  # When MSCKF fails (100%), using horizontal velocity causes massive drift (5km in 5min)
  views:
    nadir:
      nadir_threshold_deg: 30.0
      sigma_scale_xy: 3.0          # INCREASED: high uncertainty for XY from nadir flow
      sigma_scale_z: 2.0           # Nadir camera has GOOD Z observability actually
      use_vz_only: false           # CRITICAL FIX v2.9.8.4: Enable XY velocity (was true)
      min_parallax: 0.3            # LOWERED: accept slow motion flow (was 0.5)
      max_corners: 2500            # More features for stability
    
    front:
      nadir_threshold_deg: 60.0
      sigma_scale_xy: 0.8          # Slightly increased from 0.6
      sigma_scale_z: 1.5           # Slightly increased from 1.2
      use_vz_only: false
      min_parallax: 1.0            # VERY LOW for slow forward motion
      max_corners: 2500
    
    side:
      nadir_threshold_deg: 60.0
      sigma_scale_xy: 1.0
      sigma_scale_z: 1.2
      use_vz_only: false
      min_parallax: 8
      max_corners: 2000

# Default camera view (nadir/front/side)
default_camera_view: "nadir"

# Use fisheye undistortion backend
use_fisheye: true

# ============================================================================
# Performance Optimization (v3.1.0)
# ============================================================================
# Trade-off: Speed vs Accuracy
# use_fast_mode=false, frame_skip=1: Full accuracy, ~700-800s runtime (2.5x realtime)
# use_fast_mode=true,  frame_skip=1: 60% faster (~400-500s), minimal accuracy loss
# use_fast_mode=true,  frame_skip=2: 80% faster (~300-350s), slight accuracy loss
fast_mode:
  use_fast_mode: false    # Reduce features (540 vs 640) + faster KLT (15x15 win, 3 levels)
  frame_skip: 1           # Process every N frames (1=all, 2=half, etc.)

# ============================================================================
# ZUPT (Zero Velocity Update) Configuration (v2.9.8)
# ============================================================================
# Detects stationary periods to apply zero-velocity constraints.
# DISABLED for helicopters: continuous vibration prevents true zero-velocity state.
# Use vibration detection instead for adaptive measurement uncertainty.
zupt:
  enabled: false                  # DISABLED: Helicopters never truly stationary (rotor vibration)
  accel_threshold: 0.5            # Acceleration threshold [m/s²] (reduced for helicopter vibration)
  gyro_threshold: 0.05            # Gyroscope threshold [rad/s] (~3°/s)
  min_duration: 2.0               # Minimum stationary duration [seconds]
  velocity_threshold: 0.2         # Velocity magnitude threshold [m/s]
  consecutive_required: 5         # Consecutive stationary samples required

# ============================================================================
# NEW: Fisheye Rectification (v2.8.0)
# ============================================================================
# Converts fisheye images to pinhole for better feature tracking.
# DISABLED: Bell412 dataset already uses calibrated Kannala-Brandt model.
# Enabling causes parallax scale errors due to rectification.
# Only enable for uncalibrated or severely distorted fisheye cameras.
rectification:
  use_rectifier: false       # DISABLED: VIO already handles fisheye correctly
  rectify_fov_deg: 90.0      # Output field of view for virtual pinhole camera

# ============================================================================
# NEW: Loop Closure Detection (v2.8.0)
# ============================================================================
# Detects when vehicle returns to previously visited location.
# Corrects accumulated yaw drift using visual feature matching.
# DISABLED for long-range outdoor flights without loops (CPU-intensive, low benefit)
loop_closure:
  use_loop_closure: false     # DISABLED: No loops in long-range flight, saves 0.3-0.5s/keyframe
  position_threshold: 30.0    # Distance threshold to consider loop candidate [m]
  min_keyframe_dist: 15.0     # Minimum distance between keyframes [m]
  min_keyframe_yaw: 20.0      # Minimum yaw change between keyframes [deg]
  min_frame_gap: 50           # Minimum frame gap for loop detection
  min_inliers: 15             # Minimum feature match inliers

# ============================================================================
# NEW: Vibration Detection (v2.8.0)
# ============================================================================
# Detects high vibration periods (helicopter rotor effects).
# Can be used to adjust measurement uncertainties.
vibration:
  use_vibration_detector: true
  window_size: 50             # Number of samples for vibration detection
  threshold_multiplier: 5.0   # Multiplier of acc_n for vibration threshold

# ============================================================================
# NEW: Terrain Referenced Navigation (TRN) v3.3.0
# ============================================================================
# Provides periodic XY position fixes using terrain profile matching.
# GPS-denied compliant - uses pre-loaded DSM/DEM terrain data.
# 
# How it works:
# 1. Collects altitude history over a window (30-60 seconds)
# 2. Searches nearby positions for terrain profile that best matches
# 3. When good match found, applies position correction to EKF
#
# Effectiveness depends on:
# - Terrain variation (better in hilly areas, worse over flat terrain)
# - DEM resolution (30m DSM is adequate for regional navigation)
# - Altitude measurement accuracy (baro + DEM-derived AGL)
#
# Expected accuracy: ~50-100m horizontal (depends on terrain)
trn:
  enabled: false               # Enable Terrain Referenced Navigation
  profile_window_sec: 30.0    # Seconds of altitude history for matching
  min_samples: 20             # Minimum samples for valid profile
  search_radius_m: 500.0      # Search radius around current estimate [m]
  search_step_m: 30.0         # Grid step size [m] - match DEM resolution
  min_terrain_variation_m: 10.0  # Minimum terrain variation for match [m]
  max_correlation_threshold: 0.7  # Minimum correlation for valid fix
  min_altitude_variation_m: 5.0   # Minimum altitude variation in profile [m]
  update_interval_sec: 10.0   # Seconds between TRN updates
  sigma_trn_xy: 50.0          # Position uncertainty from TRN [m]

# ============================================================================
# VPS Configuration (Visual Positioning System - Satellite Matching)
# ============================================================================
vps:
  enabled: false
  
  # Processing parameters
  output_size: [512, 512]          # Output patch size for matching
  device: "cuda"                   # 'cuda' or 'cpu' for matcher
  max_keypoints: 2048              # Maximum keypoints to extract
  
  # Quality thresholds
  min_inliers: 20                  # Minimum inliers for valid match
  max_reproj_error: 5.0            # Maximum reprojection error [px]
  min_confidence: 0.3              # Minimum confidence score
  
  # Altitude limits (AGL)
  min_altitude: 30.0               # Minimum altitude for VPS [m]
  max_altitude: 500.0              # Maximum altitude for VPS [m]
  
  # Timing
  min_update_interval: 0.5         # Minimum seconds between VPS updates
  
  # Stochastic Cloning (Latency Handling)
  max_delay_sec: 0.5               # Maximum delay before clone expires [sec]
  max_clones: 3                    # Maximum number of clones to maintain
  
  # Camera selection (which extrinsics to use)
  camera_view: "nadir"             # 'nadir', 'front', or 'side'
