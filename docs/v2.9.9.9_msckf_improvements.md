# v2.9.9.9: MSCKF Success Rate Improvements

**Date**: December 15, 2025  
**Commit**: 0d31890  
**Previous**: v2.9.9.8 (5a39cef)

## Problem Statement

MSCKF triangulation had **4.1% success rate** with massive failures:

```
[MSCKF-STATS] Total: 457,942, Success: 18,580 (4.1%)
  fail_baseline: 17,800 (3.9%)
  fail_parallax: 1,327 (0.3%)
  fail_depth_sign: 221,486 (48.4%) â† CRITICAL
  fail_depth_large: 12 (0.0%)
  fail_reproj_error: 126,408 (27.6%) â† CRITICAL
  fail_nonlinear: 69,763 (15.2%) â† CRITICAL
  fail_other: 2,566 (0.6%)
```

**Root Causes:**
1. **fail_depth_sign (48.4%)**: Overly strict depth > 0 check rejects valid features
2. **fail_reproj_error (27.6%)**: Thresholds too tight for helicopter motion (vibration, jitter, rolling shutter)
3. **fail_nonlinear (15.2%)**: Poor convergence in Gauss-Newton optimization

---

## Changes Implemented

### 1. Code Refactoring: Ground Truth Error Handling

**Motivation**: Better code organization and graceful GT unavailability handling

**Changes:**
- Moved `get_ground_truth_error()` from `main_loop.py` â†’ `output_utils.py`
- Returns `(None, None)` gracefully when GT data unavailable
- No errors/crashes without PPK trajectory
- Function now reusable across modules

**Files Modified:**
- `vio/output_utils.py`: Added standalone function
- `vio/main_loop.py`: Import and call from output_utils

**Impact**: 
- âœ… System works without ground truth (no crashes)
- âœ… NEES calculation still works when GT available
- âœ… Better code structure

---

### 2. MSCKF Improvement: Relax Depth Sign Check

**Problem**: Midpoint triangulation sometimes produces slightly negative depths due to numerical errors, but feature is actually valid.

**Root Cause Analysis:**
```python
# Midpoint method:
depth0 = np.dot(p_init - c0, ray0_w)  # Can be -0.3m from numerical error
depth1 = np.dot(p_init - c1, ray1_w)  # Feature actually at 5m depth

# OLD (v2.9.9.8): Reject ANY negative depth
if depth0 <= 0.0 or depth1 <= 0.0:  # âŒ Rejects 48.4%!
    fail_depth_sign += 1
```

**Solution (v2.9.9.9):**
```python
# NEW: Allow small negative depths (numerical tolerance)
if depth0 < -0.5 or depth1 < -0.5:  # âœ… Only reject if clearly behind
    fail_depth_sign += 1
    
# Rationale:
# - Midpoint gives initial estimate (may be imprecise)
# - Nonlinear refinement corrects it
# - Allow -0.5m tolerance for numerical errors
```

**Additional Changes:**
- During reprojection validation: `depth < 0.1` â†’ `depth < -0.2`
- During nonlinear optimization: `depth <= 0.1` â†’ `depth < -1.0`
- Added near-zero depth handling: `if abs(depth) < 0.01: depth = Â±0.01`

**Expected Impact:**
- fail_depth_sign: **48.4% â†’ 20-25%** (50% reduction)

---

### 3. MSCKF Improvement: Relax Reprojection Thresholds

**Problem**: Helicopter/drone motion has inherent noise sources:
- Vibration from rotors
- Rolling shutter distortion
- IMU jitter
- Slight camera calibration errors

**Root Cause Analysis:**
```python
# OLD thresholds (v2.9.9.8):
MAX_REPROJ_ERROR_PX = 12.0 pixels       # Pixel-level error
MAX_PIXEL_REPROJ_ERROR = 12.0 pixels    # Kannala-Brandt reprojection
avg_normalized_error_threshold = 0.10   # Normalized coordinates

# Results:
# - 27.6% rejected as fail_reproj_error
# - Many valid features rejected due to motion noise
```

**Solution (v2.9.9.9):**
```python
# NEW: More realistic thresholds for aerial platforms
MAX_REPROJ_ERROR_PX = 20.0 pixels       # Was 12.0 (+67%)
MAX_PIXEL_REPROJ_ERROR = 20.0 pixels    # Was 12.0 (+67%)
avg_normalized_error_threshold = 0.15   # Was 0.10 (+50%)
```

**Rationale:**
- 20 pixels â‰ˆ 1.4% of 1440px width (acceptable for feature matching)
- Rolling shutter can cause 5-10px shift during motion
- Camera calibration accuracy Â±5px typical
- Vibration adds 3-5px noise
- **Total budget: 12-20px is realistic**

**Expected Impact:**
- fail_reproj_error: **27.6% â†’ 15-20%** (40% reduction)

---

### 4. MSCKF Improvement: Better Nonlinear Convergence

**Problem**: Gauss-Newton optimization fails to converge for difficult cases (15.2% fail_nonlinear)

**Root Cause Analysis:**
```python
# OLD (v2.9.9.8): Weak damping, unstable for ill-conditioned cases
lambda_lm = max(1e-3 * trace(HTH)/3, 1e-6)  # Small damping
max_step = 10.0                              # Large steps
convergence_threshold = 1e-6                 # Very tight
```

**Solution (v2.9.9.9):**
```python
# NEW: More aggressive Levenberg-Marquardt damping
lambda_lm = max(1e-2 * trace(HTH)/3, 1e-5)  # 10Ã— larger (more stable)
max_step = 5.0                               # Conservative steps
convergence_threshold = 1e-5                 # Relaxed (faster)

# Benefits:
# 1. Larger damping â†’ better stability for poorly conditioned Hessian
# 2. Smaller steps â†’ avoid overshooting minima
# 3. Relaxed threshold â†’ accept "good enough" solutions
```

**Additional Improvements:**
- Handle near-zero depth gracefully (prevent division by zero)
- More lenient depth check during optimization (`< -1.0` instead of `<= 0.1`)
- Allow optimizer to temporarily go negative (will converge to positive)

**Expected Impact:**
- fail_nonlinear: **15.2% â†’ 8-12%** (40% reduction)

---

## Expected Results

### Success Rate Prediction

**Baseline (v2.9.9.8):**
```
Total: 457,942
Success: 18,580 (4.1%)
```

**Expected (v2.9.9.9):**
```
Total: ~460,000
Success: ~80,000-110,000 (17-24%)  â† 4-6Ã— improvement!

Failure breakdown:
  fail_depth_sign: 48.4% â†’ 22% (115k â†’ 50k)
  fail_reproj_error: 27.6% â†’ 17% (126k â†’ 75k)
  fail_nonlinear: 15.2% â†’ 10% (70k â†’ 45k)
```

**Conservative Estimate**: 15% success (3.6Ã— improvement)  
**Optimistic Estimate**: 25% success (6Ã— improvement)

### Impact on VIO Performance

**MSCKF provides:**
- XY position constraint (reduces drift)
- Attitude correction (from feature reprojection)
- Scale observability (depth from triangulation)

**Expected Improvements:**
1. **Position accuracy**: 3832m â†’ 1500-2000m (with 15% MSCKF)
2. **Velocity constraint**: More frequent updates reduce divergence
3. **Filter consistency**: Better observability â†’ more realistic covariance

---

## Testing Instructions

### 1. Run Benchmark

```bash
cd /home/cvteam/vio_vps_repo
git pull origin main  # Get v2.9.9.9 (0d31890)
./scripts/benchmark_modular.sh
```

### 2. Analyze MSCKF Stats

```python
import re

log_file = "benchmark_modular_YYYYMMDD_HHMMSS/run_output.log"
with open(log_file, 'r') as f:
    content = f.read()

# Extract MSCKF stats
match = re.search(r'\[MSCKF-STATS\] Total: (\d+), Success: (\d+) \(([\d.]+)%\)', content)
total, success, rate = int(match.group(1)), int(match.group(2)), float(match.group(3))

print(f"MSCKF Success: {success}/{total} = {rate:.1f}%")
print(f"Improvement: {rate / 4.1:.1f}Ã— baseline")

# Extract failure breakdown
for fail_type in ['fail_depth_sign', 'fail_reproj_error', 'fail_nonlinear']:
    match = re.search(rf'{fail_type}: (\d+) \(([\d.]+)%\)', content)
    if match:
        count, pct = int(match.group(1)), float(match.group(2))
        print(f"{fail_type}: {count} ({pct:.1f}%)")
```

### 3. Compare Error Logs

```python
import pandas as pd
import numpy as np

# Old benchmark (v2.9.9.8)
df_old = pd.read_csv("benchmark_modular_20251215_194145/preintegration/error_log.csv")

# New benchmark (v2.9.9.9)
df_new = pd.read_csv("benchmark_modular_YYYYMMDD_HHMMSS/preintegration/error_log.csv")

# Compare position error
pos_err_old = df_old['pos_error_m'].iloc[-1]
pos_err_new = df_new['pos_error_m'].iloc[-1]

print(f"Position Error: {pos_err_old:.1f}m â†’ {pos_err_new:.1f}m")
print(f"Improvement: {(1 - pos_err_new/pos_err_old)*100:.1f}%")
```

---

## Success Criteria

### Primary Goals
- âœ… **MSCKF success rate > 12%** (3Ã— improvement from 4.1%)
- âœ… **fail_depth_sign < 30%** (down from 48.4%)
- âœ… **fail_reproj_error < 20%** (down from 27.6%)
- âœ… **fail_nonlinear < 12%** (down from 15.2%)

### Secondary Goals
- âœ… **Position error < 2000m** (down from 3832m in v2.9.9.7)
- âœ… **VIO_VEL acceptance > 85%** (maintain from v2.9.9.8)
- âœ… **No crashes or NaN errors**

### Stretch Goals
- ðŸŽ¯ **MSCKF success rate > 20%** (5Ã— improvement)
- ðŸŽ¯ **Position error < 1500m** (match v2.9.9.6 baseline)
- ðŸŽ¯ **fail_depth_sign < 25%**

---

## Rollback Plan (If Needed)

If v2.9.9.9 performs worse than v2.9.9.8:

```bash
git checkout 5a39cef  # v2.9.9.8 (2Ã— process noise + GT NEES)
```

**Revert Only MSCKF Changes:**
```bash
git checkout 5a39cef -- vio/msckf.py
git commit -m "Revert MSCKF changes, keep GT error refactor"
```

**Indicators for Rollback:**
- MSCKF success rate < 4.1% (worse than baseline)
- Position error > 4000m (worse than v2.9.9.7)
- VIO_VEL acceptance < 80%
- Frequent crashes or NaN errors

---

## Technical Details

### Code Structure Changes

**Before (v2.9.9.8):**
```
vio/main_loop.py:
  - get_ground_truth_error() method (80 lines)
  - Called in VIO_VEL update block
  
vio/output_utils.py:
  - log_measurement_update() with NEES calculation
  - Received (None, None) for state_error/cov
```

**After (v2.9.9.9):**
```
vio/output_utils.py:
  - get_ground_truth_error() function (90 lines)
  - log_measurement_update() with NEES calculation
  - Self-contained GT error computation
  
vio/main_loop.py:
  - Import get_ground_truth_error from output_utils
  - Call with explicit parameters (kf, ppk, flight_log, lat0, lon0)
  - Cleaner separation of concerns
```

### MSCKF Parameter Changes

| Parameter | v2.9.9.8 | v2.9.9.9 | Change | Impact |
|-----------|----------|----------|--------|--------|
| Initial depth check | `> 0.0` | `> -0.5` | +0.5m tolerance | â†“ fail_depth_sign |
| Reprojection depth | `> 0.1` | `> -0.2` | +0.3m tolerance | â†“ fail_depth_sign |
| Optimization depth | `> 0.1` | `> -1.0` | +1.1m tolerance | â†“ fail_nonlinear |
| Pixel error threshold | 12.0 px | 20.0 px | +67% | â†“ fail_reproj_error |
| Normalized error | 0.10 | 0.15 | +50% | â†“ fail_reproj_error |
| LM damping | 1e-3 | 1e-2 | 10Ã— | â†“ fail_nonlinear |
| Max step size | 10.0 | 5.0 | 50% | â†“ fail_nonlinear |
| Convergence tol | 1e-6 | 1e-5 | 10Ã— | â†“ fail_nonlinear |

---

## Related Versions

- **v2.9.9.6**: Baseline (1323m error, 11.8Ïƒ overconfidence)
- **v2.9.9.7**: Failed (4Ã— process noise too aggressive, 3832m error)
- **v2.9.9.8**: Corrected (2Ã— process noise + GT NEES working)
- **v2.9.9.9**: Current (GT refactor + MSCKF improvements)

---

## Contact & Support

**Author**: VIO Project Team  
**Repository**: github.com/francekrit41/vio_vps.git  
**Branch**: main (commit 0d31890)

For issues or questions, create GitHub issue with:
- Benchmark output log
- Error logs (error_log.csv, debug_residuals.csv)
- MSCKF stats from console output
