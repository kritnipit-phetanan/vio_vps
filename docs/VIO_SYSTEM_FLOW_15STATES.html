<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIO System Complete Flow (v3.9.6 - 15D States)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: #f0f4f8; color: #333; line-height: 1.6; }
        h1 { color: #1a1a2e; border-bottom: 4px solid #38a169; padding-bottom: 15px; font-size: 2em; }
        h2 { color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 40px; font-size: 1.5em; }
        h3 { color: #4a5568; margin-top: 25px; }
        .version-badge { background: #38a169; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; margin-left: 10px; }
        .mermaid { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 25px 0; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; margin: 20px 0; }
        th { background: linear-gradient(135deg, #38a169, #2f855a); color: white; padding: 14px 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background: #f7fafc; }
        tr:last-child td { border-bottom: none; }
        code { background: #edf2f7; padding: 3px 8px; border-radius: 4px; font-family: 'Monaco', 'Consolas', monospace; font-size: 0.9em; color: #2f855a; }
        pre { background: #1a1a2e; color: #a8dadc; padding: 20px; border-radius: 12px; overflow-x: auto; font-size: 0.9em; }
        .status-active { color: #38a169; font-weight: bold; }
        .status-optional { color: #d69e2e; font-weight: bold; }
        .status-unused { color: #e53e3e; font-weight: bold; }
        .section-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; }
        .state-box { background: linear-gradient(135deg, #38a169, #2f855a); color: white; padding: 25px; border-radius: 12px; margin: 20px 0; }
        .state-box pre { background: rgba(0,0,0,0.3); color: #fff; }
        .comparison-box { background: linear-gradient(135deg, #4299e1, #3182ce); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .legend { display: flex; gap: 20px; flex-wrap: wrap; padding: 15px; background: #edf2f7; border-radius: 8px; margin: 15px 0; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .legend-active { background: #38a169; }
        .legend-optional { background: #d69e2e; }
        .legend-unused { background: #e53e3e; }
    </style>
</head>
<body>
    <h1>ğŸš VIO System Complete Flow <span class="version-badge">15D States (v3.9.6)</span></h1>

    <div class="comparison-box">
        <h3 style="margin-top:0; color: white;">ğŸ“Š 15D vs 18D Comparison</h3>
        <table style="background: rgba(255,255,255,0.15); color: white;">
            <tr><th style="background: rgba(0,0,0,0.2);">Feature</th><th style="background: rgba(0,0,0,0.2);">15D (This Branch)</th><th style="background: rgba(0,0,0,0.2);">18D (main)</th></tr>
            <tr><td>Nominal State</td><td><strong>16D</strong></td><td>19D</td></tr>
            <tr><td>Error State</td><td><strong>15D</strong></td><td>18D</td></tr>
            <tr><td>Mag Bias in State</td><td>âŒ No</td><td>âœ… Yes (online estimation)</td></tr>
            <tr><td>Hard Iron</td><td>Static from config</td><td>Static OR estimated</td></tr>
        </table>
    </div>

    <h2>ğŸ“‚ vio/ Scripts Inventory (25 files)</h2>
    <div class="legend">
        <div class="legend-item"><div class="legend-dot legend-active"></div> Active</div>
        <div class="legend-item"><div class="legend-dot legend-optional"></div> Optional/Conditional</div>
        <div class="legend-item"><div class="legend-dot legend-unused"></div> Not Used</div>
    </div>
    <table>
        <tr><th>#</th><th>Script</th><th>Status</th><th>Phase</th><th>Description</th></tr>
        <tr><td>1</td><td><code>__init__.py</code></td><td class="status-active">âœ…</td><td>-</td><td>Package initialization, version info</td></tr>
        <tr><td>2</td><td><code>config.py</code></td><td class="status-active">âœ…</td><td>1</td><td>VIOConfig dataclass, YAML loader</td></tr>
        <tr><td>3</td><td><code>data_loaders.py</code></td><td class="status-active">âœ…</td><td>2</td><td>IMU/MAG/VPS/DEM/Image loading</td></tr>
        <tr><td>4</td><td><code>ekf.py</code></td><td class="status-active">âœ…</td><td>3</td><td>ExtendedKalmanFilter class (<strong>16D</strong>)</td></tr>
        <tr><td>5</td><td><code>state_manager.py</code></td><td class="status-active">âœ…</td><td>3</td><td>State initialization, covariance (<strong>15Ã—15</strong>)</td></tr>
        <tr><td>6</td><td><code>main_loop.py</code></td><td class="status-active">âœ…</td><td>4</td><td>VIORunner orchestrator</td></tr>
        <tr><td>7</td><td><code>propagation.py</code></td><td class="status-active">âœ…</td><td>5</td><td>IMU propagation, ZUPT</td></tr>
        <tr><td>8</td><td><code>imu_preintegration.py</code></td><td class="status-active">âœ…</td><td>5</td><td>Forster preintegration (<strong>Î¦ 15Ã—15</strong>)</td></tr>
        <tr><td>9</td><td><code>imu_driven.py</code></td><td class="status-active">âœ…</td><td>5</td><td>IMU-driven mode handler</td></tr>
        <tr><td>10</td><td><code>magnetometer.py</code></td><td class="status-active">âœ…</td><td>6</td><td>Mag calibration (static hard/soft iron)</td></tr>
        <tr><td>11</td><td><code>measurement_updates.py</code></td><td class="status-active">âœ…</td><td>6</td><td>Mag/Height/Velocity updates</td></tr>
        <tr><td>12</td><td><code>vio_frontend.py</code></td><td class="status-active">âœ…</td><td>7</td><td>Feature tracking (KLT)</td></tr>
        <tr><td>13</td><td><code>msckf.py</code></td><td class="status-active">âœ…</td><td>7</td><td>Multi-State Constraint KF</td></tr>
        <tr><td>14</td><td><code>camera.py</code></td><td class="status-active">âœ…</td><td>7</td><td>Camera projection models</td></tr>
        <tr><td>15</td><td><code>fisheye_rectifier.py</code></td><td class="status-active">âœ…</td><td>7</td><td>Kannala-Brandt rectification</td></tr>
        <tr><td>16</td><td><code>vps_integration.py</code></td><td class="status-active">âœ…</td><td>8</td><td>VPS/GPS updates</td></tr>
        <tr><td>17</td><td><code>loop_closure.py</code></td><td class="status-active">âœ…</td><td>8</td><td>Yaw drift correction</td></tr>
        <tr><td>18</td><td><code>output_utils.py</code></td><td class="status-active">âœ…</td><td>9</td><td>Debug output, CSV writers</td></tr>
        <tr><td>19</td><td><code>math_utils.py</code></td><td class="status-active">âœ…</td><td>*</td><td>Math helpers (quaternions, etc)</td></tr>
        <tr><td>20</td><td><code>numerical_checks.py</code></td><td class="status-active">âœ…</td><td>*</td><td>Covariance PSD checks, tripwires</td></tr>
        <tr><td>21</td><td><code>plane_detection.py</code></td><td class="status-optional">âš ï¸</td><td>7</td><td>RANSAC plane fitting (optional)</td></tr>
        <tr><td>22</td><td><code>plane_msckf.py</code></td><td class="status-optional">âš ï¸</td><td>7</td><td>Plane-constrained MSCKF (optional)</td></tr>
        <tr><td>23</td><td><code>plane_utils.py</code></td><td class="status-optional">âš ï¸</td><td>7</td><td>Plane geometry utilities (optional)</td></tr>
        <tr><td>24</td><td><code>event_driven.py</code></td><td class="status-unused">âŒ</td><td>N/A</td><td><strong>NOT USED</strong> (legacy)</td></tr>
        <tr><td>25</td><td><code>trn.py</code></td><td class="status-unused">âŒ</td><td>N/A</td><td><strong>NOT USED</strong> (TRN disabled)</td></tr>
    </table>

    <h2>ğŸ”„ Detailed Process Flow</h2>
    <div class="mermaid">
flowchart TD
    subgraph PHASE1["Phase 1: CLI & Config"]
        A1["run_vio.py<br/>main()"] --> A2["vio/config.py<br/>load_config()"]
        A2 --> A3["VIOConfig dataclass"]
    end

    subgraph PHASE2["Phase 2: Data Loading"]
        A3 --> B1["vio/data_loaders.py"]
        B1 --> B2[load_imu_csv]
        B1 --> B3[load_quarry_csv]
        B1 --> B4[load_mag_csv]
        B1 --> B5[load_dem]
        B1 --> B6[load_images_index]
    end

    subgraph PHASE3["Phase 3: EKF Init (16D)"]
        B2 & B3 & B4 & B5 & B6 --> C1["vio/main_loop.py<br/>VIORunner.__init__()"]
        C1 --> C2["vio/ekf.py<br/>ExtendedKalmanFilter(dim_x=16)"]
        C2 --> C3["vio/state_manager.py<br/>initialize_ekf_state()"]
        C3 --> C4["vio/state_manager.py<br/>initialize_covariance() â†’ P(15Ã—15)"]
    end

    subgraph PHASE4["Phase 4: Main Loop"]
        C4 --> D1["vio/main_loop.py<br/>run()"]
        D1 --> D2{IMU sample?}
        D2 -->|Yes| D3["process_imu_sample()"]
        D2 -->|No| D4{Image frame?}
        D4 -->|Yes| D5["process_image_frame()"]
    end

    subgraph PHASE5["Phase 5: IMU Propagation"]
        D3 --> E1["vio/propagation.py<br/>propagate_to_timestamp()"]
        E1 --> E2["vio/imu_preintegration.py<br/>propagate()"]
        E2 --> E3["compute_error_state_jacobian()<br/>Î¦(15Ã—15)"]
        E2 --> E4["compute_error_state_process_noise()<br/>Q(15Ã—15)"]
        E3 & E4 --> E5["P = Î¦Ã—PÃ—Î¦áµ€ + Q"]
        E5 --> E6["vio/propagation.py<br/>ZUPT detection"]
    end

    subgraph PHASE6["Phase 6: Sensor Updates"]
        D3 --> F1["vio/main_loop.py<br/>process_magnetometer()"]
        F1 --> F2["vio/magnetometer.py<br/>calibrate_magnetometer()<br/>(static hard/soft iron)"]
        F2 --> F3["compute_yaw_from_mag()"]
        F3 --> F4["vio/measurement_updates.py<br/>apply_magnetometer_update()<br/>(yaw only, no bias estimation)"]
        E6 --> F6["vio/measurement_updates.py<br/>apply_height_update()"]
        E6 --> F7["apply_velocity_update()"]
    end

    subgraph PHASE7["Phase 7: Visual Processing"]
        D5 --> G1["vio/vio_frontend.py<br/>track_features_klt()"]
        G1 --> G2["vio/camera.py<br/>project/unproject"]
        G1 --> G3["vio/fisheye_rectifier.py"]
        G2 & G3 --> G4["create_clone()"]
        G4 --> G5["marginalize_oldest_pose()"]
        G5 --> G6["vio/msckf.py<br/>msckf_update()"]
    end

    subgraph PHASE8["Phase 8: External Updates"]
        D1 --> H1["vio/vps_integration.py"]
        D1 --> H2["vio/loop_closure.py"]
    end

    subgraph PHASE9["Phase 9: Output"]
        F4 & F6 & F7 & G6 & H1 & H2 --> I1["vio/output_utils.py<br/>save_pose_to_csv()"]
    end
    </div>

    <h2>ğŸ“Š State Vector (15D - v3.9.6)</h2>
    <div class="state-box">
        <h3 style="margin-top:0; color: white;">Nominal State (16D):</h3>
        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0:3]   p      - Position (ENU)     â”‚
â”‚ [3:6]   v      - Velocity           â”‚
â”‚ [6:10]  q      - Quaternion         â”‚
â”‚ [10:13] bg     - Gyro bias          â”‚
â”‚ [13:16] ba     - Accel bias         â”‚
â”‚ [16:23] Cloneâ‚€ - Camera pose 0      â”‚
â”‚ [23:30] Cloneâ‚ - Camera pose 1...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
        <h3 style="color: white;">Error State (15D + 6N):</h3>
        <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0:3]   Î´p    - Position error      â”‚
â”‚ [3:6]   Î´v    - Velocity error      â”‚
â”‚ [6:9]   Î´Î¸    - Rotation error      â”‚
â”‚ [9:12]  Î´bg   - Gyro bias error     â”‚
â”‚ [12:15] Î´ba   - Accel bias error    â”‚
â”‚ [15:21] Î´Câ‚€   - Clone 0 error       â”‚
â”‚ ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
    </div>

    <h2>ğŸ§² Magnetometer Handling (15D)</h2>
    <div class="section-box">
        <table>
            <tr><th>Aspect</th><th>15D Implementation</th></tr>
            <tr><td>Hard Iron Offset</td><td><strong>Static</strong> from <code>MAG_HARD_IRON_OFFSET</code> in config</td></tr>
            <tr><td>Soft Iron Matrix</td><td><strong>Static</strong> from <code>MAG_SOFT_IRON_MATRIX</code> in config</td></tr>
            <tr><td>Online Estimation</td><td>âŒ Not available</td></tr>
            <tr><td>Jacobian</td><td>Only yaw (H[6:9]), no bias terms</td></tr>
            <tr><td>Calibration</td><td>Pre-flight static calibration required</td></tr>
        </table>
    </div>

    <h2>ğŸ“‹ Key Formulas</h2>
    <div class="section-box">
        <h3>Magnetometer Update (15D)</h3>
        <pre>
mag_calibrated = (mag_raw - hard_iron) @ soft_iron_inv
yaw_measured = atan2(mag_calibrated[1], mag_calibrated[0])
innovation = yaw_measured - yaw_predicted
H = [0, 0, 0, 0, 0, 0, 0, 0, yaw_sign, 0, 0, 0, 0, 0, 0]  // 15D
                            â†‘ Î´Î¸_z
        </pre>
        <h3>Clone Indices (15D)</h3>
        <pre>
num_clones = (kf.x.shape[0] - 16) // 7
err_dim = 15 + 6 * num_clones
clone_start_nominal = 16 + clone_id * 7
clone_start_error = 15 + clone_id * 6
        </pre>
    </div>

    <script>mermaid.initialize({startOnLoad:true, theme:'default', flowchart:{curve:'basis'}});</script>
</body>
</html>
